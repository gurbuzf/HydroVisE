<!DOCTYPE html>
<html lang="US">

<head>
    <link rel="icon" type="image/ico" href="favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>HydroEval - Hydrologic Evaluation Tool</title>
    <!--CSS StyleSheets-->

    <link rel="stylesheet" href="dist/leaflet.css"/>
    <link rel="stylesheet" href="dist/leaflet.loader.css"/>
    <link rel="stylesheet" href="css/examples.css"/>


    <!-- Third Party Applications-->
    <script src="dist/d3.v4.min.js"></script>

    <!--     <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script> -->
    <script src='dist/html2canvas.min.js'></script>
    <script src='dist/FileSaver.js'></script>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Roboto:100,400" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.2.3/math.js"></script>
    <script src="dist/jquery-2.1.4.min.js"></script>
    <!--Major Components-->
    <script src="applications/visualization/timeseries/tracePlot.js"></script>
    <script src="applications/visualization/maps/markerPlot.js"></script>
    <script src="applications/visualization/maps/2dMap.js"></script>
    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-image/v0.0.4/leaflet-image.js'></script>
    <!-- new added -->
    <script src="applications/metricFunctions/synch.js"></script>
    <script src="applications/moment.js"></script>
    <!--<script src="applications/metricFunctions/core.js"></script>-->
    <script src="applications/jquery-3.4.1.js"></script>
    <script src="applications/general/common.js"></script>
    <script src="applications/metricFunctions/math.js"></script>
    <script src="applications/metricFunctions/trapz.js"></script>
    <script src="applications/metricFunctions/all_metrics.js"></script>
    <script src="applications/dataReaderNew.js"></script>
    <!--Minor Components-->


    <script src="dist/colors.js"></script>
    <script src="dist/numeric.js"></script>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
    <script src="dist/geotiff.js"></script>
    <script src="dist/GeotiffParser.js"></script>
    <!--    <script src="dist/geotiff.js"></script>-->
    <script src="dist/chroma.min.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>


    <!-- Plugin -->
    <script src="dist/leaflet.canvaslayer.field.js"></script>
    <!--    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>-->

    <script src="dist/leaflet.loader.js"></script>
    <script src="applications/leaflet_plugins/bundle.js"></script>
    <script src="dist/KML.js"></script>
    <link rel="stylesheet" type="text/css" href="dist/loading-bar.css"/>
    <script type="text/javascript" src="dist/loading-bar.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
    <script src="dist/leaflet.loader.js"></script>
    <link rel="stylesheet" href="dist/leaflet.loader.css"/>
    <script src="applications/controlElements/controlFunctionsSynched.js"></script>
    <script src="applications/controlElements/mapControlElements.js"></script>
    <script src="https://unpkg.com/jszip@3.1.5/dist/jszip.min.js"></script>
    <!-- @tmcw/togeojson -->
    <script src="https://unpkg.com/@tmcw/togeojson@3.0.1/dist/togeojsons.min.js"></script>
    <!-- geojson-vt -->
    <script src="https://unpkg.com/geojson-vt@3.0.0/geojson-vt.js"></script>
    <!-- Leaflet-KMZ -->
    <script src="https://unpkg.com/leaflet-kmz@latest/dist/leaflet-kmz.js"></script>
    <!--    <script src="dist/togeojson.js"></script>-->

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        $(function () {
            $("#sortable").sortable();
            $("#sortable").disableSelection();
            $("#sortable").on("sortstop", function (event, ui) {
                console.log('test')
            });
        });
    </script>
</head>
<body>
<div id="progressDIV">
    <div class="bgLoading" id="progressbar">10%</div>
</div>

<div id='map' class="noselect"></div>
<div id="colorbar" class="noselect"></div>
<div id="canvasDIV"></div>
<div class="tab" style="z-index: 3;">
    <button class="tablinks" onclick="open2DTab(event, 'SMAP')">SMAP</button>
    <button class="tablinks" onclick="open2DTab(event, 'SMOS')">SMOS</button>
    <button class="tablinks" onclick="open2DTab(event, 'StageIV')">Stage IV</button>
    <div id="SMAP" class="tabcontent"><h3>SMAP</h3></div>
    <div id="SMOS" class="tabcontent"><h3>SMOS</h3>
        <p>ssss</p></div>
    <div id="StageIV" class="tabcontent"><h3>Stage IV </h3></div>
</div>
</div>

</div>

<div class="generic-control-bar year-control-bar">
    <div class="year-button" onclick="changeYear($(this).data('value'))" data-value="-1">-</div>
    <div id="year-selected" class="year-button" data-year=2015>2015</div>
    <div class="year-button" onclick="changeYear($(this).data('value'))" data-value="1">+</div>
</div>
<div class="plot-control-bar noselect">
    <div id="plot-button" class="generic-button"
         onclick="if (layerGeo!==undefined && layerGeo.isVisible()===true){layerGeo.hide(); bar._container.style.opacity=0}else if (layerGeo!==undefined && layerGeo.isVisible()===false){layerGeo.show(); bar._container.style.opacity=1}">
        <!--<img src="smev/smev.img/plot_ico.png">-->
        <img src="dist/images/raster_layer_small.png">
    </div>
    <div id="plotly-button" class=" generic-button"
         onclick="hideShowCanvas()">
        <!--<img src="smev/smev.img/plot_ico.png">-->
        <img src="dist/images/plot_ico.png">
    </div>
    <div class="generic-button" id="screenshot" onclick="export_report()" value="Export Report">
        <img src="dist/images/screen_cap ture_small.png">
    </div>
</div>

<!—container positioned absolute -->
<div class="custom-control-container noselect">
    <div class="metricTypeDIV">
        <div class="metricTypeControl"
             onclick="($('.metricTypeOptions').css('display') == 'block') ? $('.metricTypeOptions').css('display', 'none') : $('.metricTypeOptions').css('display', 'block');">
            Performance<img class="dropDownArrow" src="http://maps.gstatic.com/mapfiles/arrow-down.png">
        </div>
        <div class="metricTypeOptions">
        </div>
    </div>
    <!—SIMULATION Second group container positioned relative -->
    <div class="simTypeDIV">

        <div class="simTypeControl"
             onclick="($('.simTypeOptions').css('display') == 'block') ? $('.simTypeOptions').css('display', 'none') : $('.simTypeOptions').css('display', 'block');">
            Sim. Type <img class="dropDownArrow" src="http://maps.gstatic.com/mapfiles/arrow-down.png">
        </div>
        <div class="simTypeOptions">

        </div>
    </div>

    <div class="baseMapDIV">
        <div class="baseMapControl"
             onclick="($('.baseMapTypeOptions').css('display') === 'block') ? $('.baseMapTypeOptions').css('display', 'none') : $('.baseMapTypeOptions').css('display', 'block');">
            Base Map<img class="dropDownArrow" src="http://maps.gstatic.com/mapfiles/arrow-down.png">
        </div>
        <div class="baseMapTypeOptions">
            <!--            <div class="dropDownItemDivBaseMap" data-mapname="light_all"-->
            <!--                 onclick="basemap_changer($(this).data('mapname'));"-->
            <!--                 style="background-color: rgb(235, 235, 235);">Light-->
            <!--            </div>-->
            <!--            <div class="dropDownItemDivBaseMap" data-mapname="Dark" onclick="basemap_changer($(this).data('mapname'));"-->
            <!--                 style="background-color: white;">Dark-->
            <!--            </div>-->
            <!--            <div class="dropDownItemDivBaseMap" data-mapname="Esri Imagery"-->
            <!--                 onclick="basemap_changer($(this).data('mapname'));"-->
            <!--                 style="background-color: white;">Esri Imagery-->
            <!--            </div>-->
            <!--            <div class="dropDownItemDivBaseMap" data-mapname="Toner" onclick="console.log($(this).data('mapname'));-->
            <!--            basemap_changer($(this).data('mapname'));"-->
            <!--                 style="background-color: white;"> Toner-->
            <!--            </div>-->
        </div>
    </div>
    <script>
        let conf = {
            metricType: {
                v1: {var_id: 'kge', var_name: 'KGE', onEvent: 'selectMetric', selected: true},
                v2: {var_id: 'timing', var_name: 'Timing', onEvent: 'selectMetric', selected: false},
                v3: {
                    var_id: 'correlationcoefficient',
                    var_name: 'Correlation',
                    onEvent: 'selectMetric',
                    selected: false
                },
                v4: {var_id: 'nRMSE', var_name: 'nRMSE', onEvent: 'selectMetric', selected: false},
                v5: {var_id: 'nMAE', var_name: 'nMAE', onEvent: 'selectMetric', selected: false},
                v6: {var_id: 'pt_change_vol', var_name: '% Vol Diff.', onEvent: 'selectMetric', selected: false},
                v7: {var_id: 'ppd', var_name: '% Peak Difference', onEvent: 'selectMetric', selected: false}
            },
            simType: {
                v1: {var_id: 'Q_ol', var_name: 'Open Loop', onEvent: 'select_sim_type', selected: true},
                v2: {
                    var_id: 'Q_assim_norm_v2',
                    var_name: 'SMAP V2',
                    onEvent: 'select_sim_type',
                    selected: false
                },
            },
            baseMapType: {
                v1: {var_id: 'light_all', var_name: 'Light', onEvent: 'basemap_changer', selected: true},
                v2: {var_id: 'Dark', var_name: 'Dark', onEvent: 'basemap_changer', selected: false},
                v3: {var_id: 'Esri Imagery', var_name: 'Esri Imagery', onEvent: 'basemap_changer', selected: false},
                v4: {var_id: 'Toner', var_name: 'Toner', onEvent: 'basemap_changer', selected: false},
            }
        };

        controlList = ['metricType', 'simType', 'baseMapType'];
        for (let i = 0; i < controlList.length; i++) {
            controlElem = controlList[i];
            let container = $("." + controlElem + "Options");
            let lst_item = "<div class='" + controlElem + "Item {3}' data-value='{0}' onclick=\"{2}(this)\">{1}</div>";
            use_config = conf[controlElem];
//             console.log(controlElem);
            Object.keys(use_config).forEach(key => {
                container.append(
                    lst_item.format(
                        use_config[key].var_id,
                        use_config[key].var_name,
                        use_config[key].onEvent,
                        use_config[key].selected ? "selected" : ''
                    )
                )
            })
        }

    </script>

    <button id="claculatemetricsButton" class="noselect" disabled="true" onclick="readData(metrics, selectedRange)">
        Calculate Event <br>Metrics
    </button>
</div>


<div id="mini_con0" class="mini_con noselect" style="display:block; top:52px; left: 70px; background-color: #162d2b;"
     onclick="toggDiv(0)">
    <!--    <div style="position:relative;top:-20px; left:-20px;"><img src="files/expandblack10px.png" onclick="toggDiv(0)"></div>-->
</div>
<div id="con0" style="display: none" class="noselect">
    <div style="color: white; background-color:#162d2b; line-height: 40px; text-align: center;">
        Map Inventory
    </div>

    <div class="legend">
        <ul id="sortable">
            <script>
                var standard = {
                    // v1: {var_id: 'nexrad_rdr.kmz', var_name: 'NEXRAD Radars', onEvent: 'toggLyrStd', selected: false},
                    v2: {
                        var_id: 'eqd_nexrad.kmz',
                        var_name: 'Thiessen Polygon',
                        onEvent: 'toggLyrStd',
                        selected: false
                    },
                    v3: {
                        var_id: 'nexrad_150_wgs84.kmz',
                        var_name: 'NEXRAD 230 km',
                        onEvent: 'toggLyrStd',
                        selected: false
                    },
                    v4: {var_id: 'nexrad230km.kmz', var_name: 'NEXRAD 230 km', onEvent: 'toggLyrStd', selected: false},
                    v5: {var_id: 'wt_area_kml.kmz', var_name: 'Wind Farms', onEvent: 'toggLyrStd', selected: false},
                    v6: {var_id: 'wt_point.geojson', var_name: 'Wind Turbines', onEvent: 'toggLyrStd', selected: false},
                    v7: {var_id: 'IACounties.geojson', var_name: 'IA Counties', onEvent: 'toggLyrStd', selected: false}
                };
                let container = $("#sortable");
                let lst_item = "<li id='li_{4}' class='ui-state-default'><input type='checkbox' onclick=\"{2}(this)\" value='{4}'><p class='key'>{1}</p>" +
                    "<input type='image' src='files/xblack10px.png' style='float: right; cursor: pointer;' value='{4}' onclick=\"removeCTXLayer(this)\"></input></li>"
                use_config = standard;
                Object.keys(use_config).forEach(key => {
                    container.append(
                        lst_item.format(
                            use_config[key].var_id,
                            use_config[key].var_name,
                            use_config[key].onEvent,
                            use_config[key].selected ? "selected" : '',
                            key
                        )
                    )
                })
            </script>
        </ul>

    </div>
    <div style="width: 100%; display: block; text-align: center;"><input type="file" id="drop"
                                                                         style="display: inline-block;max-width: 89px;"><label
            for="drop"></label></div>
</div>


<script src="dist/dropDatasortable.js"></script>
<script src="config.js"></script>
<script>
    dragElement(document.getElementById("mini_con0"), document.getElementById("con0"));
    let zoom_state = false;
    var bar;
    var leaflet_layers = [];
    let cur_basemap = map_config.basemapList.default.id;
    var lid;
    let url = map_config.basemapList.default.url;
    // initialize the map on the "map" div with a given center and zoom
    var map = L.map('map', {
        center: map_config.center,
        zoom: map_config.defaultZoom,
        maxZoom: map_config.maxZoom
        // renderer: L.svg()
    });
    var basemap = L.tileLayer(map_config.basemapList.default.url, {
        attribution: map_config.basemapList.default.attribution,
        subdomains: map_config.basemapList.default.subdomains
    });

    basemap.addTo(map);
    map.getRenderer(map).options.padding = 0;

    var printer = L.easyPrint({
        tileLayer: basemap,
        sizeModes: ['Current', 'A4Landscape', 'A4Portrait', 'A3Size'],
        filename: 'Hydroeval',
        exportOnly: true,
        hideControlContainer: true
    }).addTo(map);

    function manualPrint() {
        printer.printMap('CurrentSize', 'MyManualPrint')
    }

    var A3Size = {
        width: 8000,
        height: 5000,
        className: 'a3CssClass',
        tooltip: 'A custom A3 size'
    }


    var zoom_metric_state = false;
    var layerGeo;
    let basin_shape;
    // console.log(layerGeo+ ' ddd');
    let loader = L.control.loader();
    //var $timelines = $('.timeline');
    var dt = [];
    let selectedRange
    let plot_state = 'event_based';
    var popup = L.popup().setContent('<div id="container" style="height:600px; width:1500px"></div>');

    // you can set .my-div-icon styles in CSS
    var init = {};
    if (typeof (init.max_yr) === 'undefined') {
        init.max_yr = 2018;//parseInt(new Date().getFullYear());
    }

    if (typeof (init.min_yr) === 'undefined') {
        init.min_yr = 2010;
    }

    // if (typeof (init.plt_visible) === 'undefined') {
    //     init.plt_visible = true;
    // }

    if (typeof (init.yr) === 'undefined') {
        init.yr = 2015;//new Date().getFullYear();
    } else {
        init.yr = parseInt(init.yr)
    }

    if (typeof (init.metric) === 'undefined') {
        init.metric = 'kge';
    } else {
        init.metric = init.metric;
    }

    if (typeof (init.sim_type) === 'undefined') {
        init.sim_type = 'Q_ol';
    } else {
        init.sim_type = init.sim_type;
    }
    var myplot;
    var group = L.featureGroup().addTo(map);
    var smap_ts;
    var metrics;
    var markerArray, marker;
    var jsonFeatures = [];
    var metric_name = 'kge';


    var lid_usgs;
    Papa.parse('data/lid_usgs.csv', {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function (results) {
            lid_usgs = results.data;
            $.getJSON("multithread_metrics.json", function (metrics_temp) {
                success:{
                    metrics = metrics_temp;
                    draw_markers(metrics, init.metric, init);
                }

            });
        }
    });
    canvasDIV = document.getElementById('canvasDIV');


    $.getJSON("data/gis_files/ifc_net3_simp.geojson", function (data) { //TODO: Add detailed River Network to the Config file
        // add GeoJSON layer to the map once the file is loaded
        // rvr_net = L.geoJson(data);
        // console.log(data);
        var tileLayer = L.vectorGrid.slicer(data, {
            rendererFactory: L.svg.tile,
            vectorTileLayerStyles: {
                sliced: function (properties, zoom) {
                    let p = properties.h_order;
                    return {
                        color: p === 3 ? '#00e4ff' :
                            p === 4 ? '#00c5ff' :
                                p === 5 ? '#00acff' :
                                    p === 6 ? '#018eff' :
                                        p === 7 ? '#007dff' :
                                            p === 8 ? '#007bff' :
                                                p === 9 ? '#0055ff' : '#000000',
                        fillOpacity: 0.5,
                        //fillOpacity: 1,
                        stroke: true,
                        fill: true,
                        fillColor: 'black',
                        //opacity: 0.2,
                        weight: p / 3,
                    }
                }

            },
            maxZoom: 22,
            indexMaxZoom: 5,       // max zoom in the initial tile index
            interactive: true
        }).addTo(map);
        tileLayer.bringToFront()
    });

    // var smap_ts_fn = 'data/smap_timestamps.csv';
    var smap_ts_am_fn = 'data/smap_ts_am.csv';
    var smap_ts_pm_fn = 'data/smap_ts_pm.csv';
    let XRange;
    if (zoom_state) {
        XRange = selectedRange;
    } else {
        XRange = ['2015-04-01 00:00:00', '2015-12-01 00:00:00'];
    }


    var layerGeo;

    var flow_stage_state;
    var histMarker;
    group.on("click", function (event) {

        var clickedMarker = event.layer;
        // do some stuff…
        // usgs_id = clickedMarker.feature.properties.USGS_id;
        lid = String(clickedMarker.feature.properties.lid);

        usgs_name = clickedMarker.feature.properties.USGS_name;
        usgs_id = clickedMarker.feature.properties.USGS_id;
        ifis_id = clickedMarker.feature.properties.ifis_id;

        // ensemble_data = [];
        // for (i = 1; i < 11; i++) {
        //     ensemble_data.push('data/results/csv_ensemble_smap/' + lid + '-' + String(i) + '.csv');
        // }

        usgs_id = '0' + usgs_id;

        console.log(zoom_state, usgs_id)
        usgs_data = 'data/usgs_gages_long/fifteen_minute1/usgs_' + String(usgs_id) + '.txt';
        assim_norm_l3_v2 = 'data/results/csv_smap_l3_v2/' + lid + '.csv';
        openloop_new = 'data/results/csv_ol/' + lid + '.csv';

        flood_level = 'data/mean_annual_flood_q/usgs_' + String(usgs_id) + '.csv';
        // console.log(String(getlength(ifis_id)));
        if (getlength(ifis_id) > 3) {
            //TODO: Add kml_fn in the config file
            kml_fn = 'data/staticLayers/geom/' + String(ifis_id) + '.kml';
        } else {
            kml_fn = 'data/staticLayers/geom/0' + String(ifis_id) + '.kml';
        }
//         console.log(lid);

        addbasin_kml(kml_fn);
        if (!zoom_state) {
            XRange = CheckXRange(init.yr);
        }
//         var files = [openloop_data, usgs_data, smap_ts_am_fn, smap_ts_pm_fn, assim_norm_l3_v2, flood_level];
        myplot = tracePlot(init.yr, lid);
        canvasDIV.style.setProperty('display', 'block');
        // map.setView([44, -93.5], 7);
        console.log(clickedMarker)
        if (histMarker) {
            histMarker.setRadius(9);
        }

        clickedMarker.setRadius(15);
        histMarker = clickedMarker;
        // group.removeLayer(clickedMarker)
        // group.addLayer(clickedMarker)
        // console.log(clickedMarker)
        return lid;
    });


    map.on('popupclose', function (e) {
        $('#container').html("Loading...");
    });

    // basemap.on('loading', function (event) {
    //     loader.addTo(map);
    //     setTimeout(function (){loader.hide();},5000);
    // });
    // basemap.on('load', function (event) {
    //     console.log('all tiles loaded');
    //     loader.hide()
    // });
    // basemap.on('tileloadstart', function (event) {
    //     console.log('start loading 1 tile');
    // });


    let kmzload = function (fn_path, fn) {
//         var layerID;
        let kmzParser = new L.KMZParser({
            async: false,
            onKMZLoaded: function (layer, name) {
//             control.addOverlay(layer, name);
                layer.addTo(map);
                layer.setStyle({'fillOpacity': 0.1});
                layer.setInteractive(false);
                leaflet_layers[fn] = [];
                leaflet_layers[fn] = layer;

                // layer.setZIndex(2);
            }
        });
        kmzParser.load(fn_path);
    };

    function contextLayerLoader(fn) {
        let fn_path;
        let ext = fn.split('.').pop();
        switch (ext) {
            case 'kmz':
                fn_path = "data/staticLayers/kmls/" + fn;
                kmzload(fn_path, fn);
                break;
            case 'kml':
                fn_path = 'data/staticLayers/kmls/' + fn;
                let layer = new L.KML(fn_path, {async: true});
                layer.on("loaded", function (e) {
                    map.addLayer(layer);
                    layer.setStyle({color: '#555555', fillColor: '#bcbcbc', 'fillOpacity': 0.1});
                    layer.setInteractive(false);
                    layer.setZIndex(0);
                    leaflet_layers[fn] = [];
                    leaflet_layers[fn] = layer;
                });
                break;
            case 'geojson':
                $.ajax({
                    dataType: "json",
                    url: 'data/staticLayers/kmls/' + fn,
                    success: function (data) {
                        // add GeoJSON layer to the map once the file is loaded
                        // rvr_net = L.geoJson(data);
                        // console.log(data);
                        var tileLayer = L.vectorGrid.slicer(data, {
                            rendererFactory: L.svg.tile,
                            vectorTileLayerStyles: {
                                sliced: function (properties, zoom) {
                                    // let p = properties.h_order;
                                    return {
                                        color: '#000000',
                                        fillOpacity: 0.5,
                                        //fillOpacity: 1,
                                        stroke: true,
                                        fill: false,
                                        fillColor: 'black',
                                        //opacity: 0.2,
                                        weight: 1,
                                    }
                                }

                            },
                        }).addTo(map);
                        leaflet_layers[fn] = tileLayer;
                        tileLayer.bringToFront()
                    }
                })
                break;
        }
    }

    const twoDTimeseriesConfig = {
        smap:{
            timestamps: {
                fPath: "data/2dData/timestamps/SMAPL3v2.json",
                extension: 'json'
            },
            fPath: "data/2dData/SMAPL3v2",
            extension: 'geotiff'
        },
    }

    TwoDTimeseries = {};
    Object.keys(twoDTimeseriesConfig).forEach(entry => {
        $.ajax({
            url: twoDTimeseriesConfig[entry].timestamps.fPath,
            dataType: twoDTimeseriesConfig[entry].timestamps.extension,
            async: false,
            success: function (data) {
                TwoDTimeseries[entry] = data
            }
        });
        // $.getJSON(, function (data) {
        //     success:{
        //         TwoDTimeseries[entry] = data;
        //     }
        // });
    });

    var tsVec = TwoDTimeseries.smap.map(dt => moment.unix(dt).format('YYYY-MM-DD HH:mm'))
    tsVec_y = tsVec.map(v => v = 1)
    var trace_data = [];
    var trace1 = {
        name: 'SMAPL3v2',
        x: tsVec,
        y: tsVec_y,
        marker: {
            // size: 10,
            // symbol:'square'
        },
        // mode: 'markers',
        type: 'bar',
        hoverinfo: 'x'
        // symbol: 'square',
        // size: 8,
        // z: tsVec.map(v => v = Math.round(Math.random()))
    };


    trace_data.push(trace1)
    // trace_data.push(trace2)
    // console.log(trace_data)


    const plotlyLayout1 = {
        margin: {
            l: 100,
            r: 80,
            b: 30,
            t: 10,
            pad: 0
        },
        yaxis:
            {
                fixedrange: true,
                visible: false,
                range: [0, 3]
            },
        xaxis: {
            type: 'date'
        },
        autosize: true,
        paper_bgcolor: '#ccc'
    };
    plotlyLayout1.xaxis.range = XRange;
    var twodslider = Plotly.newPlot('SMAP', trace_data, plotlyLayout1, {displayModeBar: false, responsive: true});
    dragLayer = document.getElementsByClassName('nsewdrag')[0]
    // let systemState = {};
    let systemState = {timeSelector:{activeTab: 'SMAP'}}


    gd = document.getElementById('SMAP');
    gd1 = document.getElementById('canvasDIV');
    var divs = [gd, gd1];

    function relayout(ed, divs) {
        // console.log(divs)
        // console.log(ed)
        ed1 = {'xaxis.range[0]': ed["xaxis.range[0]"], 'xaxis.range[1]': ed["xaxis.range[1]"]};
        divs.forEach((div, i) => {
            if (div.layout != undefined) {
                let x = div.layout.xaxis;
                if (ed["xaxis.autorange"] && x.autorange) return;
                if (
                    x.range[0] != ed["xaxis.range[0]"] ||
                    x.range[1] != ed["xaxis.range[1]"]
                ){
                    Plotly.relayout(div, ed1);
                }
                // ed1  = {xaxis.range[0]: ed["xaxis.range[0]"], xaxis.range[1]: ed["xaxis.range[0]"]}


            }

        });
    }


    var plots = [gd, gd1];
    plots.forEach(div => {
        if (div.layout != undefined) {
            console.log(div)
            div.on("plotly_relayout", function (ed) {
                zoom_state = true;
                selectedRange = [ed["xaxis.range[0]"], ed["xaxis.range[1]"]];
                // console.log(ed);
                relayout(ed, divs);
            });
        }
    });
    gd.on('plotly_hover', function (data) {
        dragLayer.style.cursor = 'pointer'
    });

    gd.on('plotly_unhover', function (data) {
        dragLayer.style.cursor = ''
    });
    gd.on('plotly_click', function (data) {

        console.log(data);
        datasetName = data.points[0].data.name;
        dt = data.points[0].x;
        dt_unix = moment(dt).format('X');
        console.log(dt, datasetName);
        fn = 'data/2dData/' + datasetName + '/' + dt_unix + '.tif';
        console.log(fn, dt_unix);
        change(fn, dt_unix);

        function change(fn, smap_fn) {

            // show icon loading
            //make the interface freeze disallow clicking
            // preserve the view point leaflet
            return d3.request(fn).responseType('arraybuffer').get(
                function (error, tiffData) {
                    // Geopotential height (BAND 0)
                    let geo = L.ScalarField.fromGeoTIFF(tiffData.response);
                    var defaultBounds = map.getBounds();

                    if (layerGeo !== undefined) {
                        map.removeLayer(layerGeo);
                    }
                    // map.removeLayer(layerGeo);
                    layerGeo = L.canvasLayer.scalarField(geo, {
                        inFilter: (v) => v !== -9999,
                        color: chroma.scale('YlGnBu').domain([0, 0.5], 5, 'quantiles'),
                        opacity: 1,
                        maxBounds: defaultBounds,
                        zoom: defaultBounds
                    });

                    layerGeo.addTo(map);
                    // console.log(layerGeo);
                    layerGeo.on('click', function (e) {
                        if (e.value !== null) {
                            let v = e.value;
                            let html = (`<span class="popupText">Soil Moisture ${Math.round(v * 1000) / 1000}</span>`);
                            let popup = L.popup()
                                .setLatLng(e.latlng)
                                .setContent(html)
                                .openOn(map);
                        }
                    });
                    map.fitBounds(defaultBounds);
                    loader.hide();
                    addsmap_colorscale(smap_fn)
                    bar._container.style.opacity = 1;
                    i_m_loading = false
                })

        }

    });


</script>
</body>
</html>